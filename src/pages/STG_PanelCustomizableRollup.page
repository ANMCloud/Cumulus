<apex:page controller="STG_PanelCustomizableRollup_CTRL" >

    <apex:slds/>
    <apex:includeScript value="{!URLFOR($Resource.CumulusStaticResources, '/npsp-slds/modal.js')}"/>

    <div class="slds-scope">
        <apex:form id="form" styleClass="slds-m-around--x-large">
            <c:STG_PageHeader sectionLabel="{!$Label.stgNavDonations}" pageLabel="{!$Label.CRLP_RollupSummary}" />
            <div class="slds-grid {!IF(!stgService.stgCRLP.Customizable_Rollups_Enabled__c, '', 'slds-hide')}">
                <div class="slds-col slds-size--1-of-1 slds-m-around--medium">
                    <p class="slds-text-body--small slds-m-top--x-small">
                        <apex:outputText escape="false" value="{!$Label.stgHelpCustomizableRollupsEnable1}"/>
                        <apex:outputText escape="false" value="{!$Label.stgHelpCustomizableRollupsEnable2}"/>
                    </p>
                </div>
            </div>
            <div class="slds-grid {!IF(stgService.stgCRLP.Customizable_Rollups_Enabled__c, '', 'slds-hide')}">
                <div class="slds-col slds-size--1-of-1 slds-m-around--medium">
                    <p class="slds-text-body--small slds-m-top--x-small">
                        <apex:outputText escape="false" value="You can find the Customizable Rollups documentation here. <br/> <br/>
                        Keep in mind that you can go back to old rollups, but any new rollups or rollup/filter changes made in Customizable Rollups, won't be applied to the old rollup settings."/>
                    </p>
                </div>
            </div>
            <c:UTIL_PageMessages allowClose="false" id="messages"/>

            <apex:outputPanel rendered="{! !isHHAccount }">
                <div class="slds" id="page_messages">
                    <div role="alert" class="slds-notify slds-notify_toast slds-notify--toast slds-theme_info slds-theme--info">
                        <div class="notify__content">
                            <div class="slds-media">
                                <div class="slds-media__figure">
                                    <apex:outputText>
                                        <svg class="slds-icon" aria-hidden="true" viewBox="0 0 24 24">
                                            <path  d="M12 .9C5.9.9.9 5.9.9 12s5 11.1 11.1 11.1 11.1-5 11.1-11.1S18.1.9 12 .9zm0 5.6c.8 0 1.4.6 1.4 1.4s-.6 1.4-1.4 1.4-1.4-.6-1.4-1.4.6-1.4 1.4-1.4zm2.3 9.7c0 .2-.2.4-.5.4h-3.6c-.3 0-.5-.1-.5-.4v-.9c0-.3.2-.5.5-.5.2 0 .4-.2.4-.4v-1.9c0-.2-.2-.5-.4-.5-.3 0-.5-.1-.5-.4v-.9c0-.3.2-.5.5-.5h2.7c.3 0 .5.2.5.5v3.7c0 .2.2.4.4.4.3 0 .5.2.5.5v.9z"/>
                                        </svg>
                                    </apex:outputText>
                                </div>
                                <div class="slds-media__body">
                                    <h2 class="slds-text-heading_small slds-text-heading--small">
                                        <apex:outputText value="{!$Label.PageMessagesInfo}: " />
                                        <apex:outputText value="{!$Label.stgCRLPHouseholdAccountError}"/>
                                    </h2>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </apex:outputPanel>

            <apex:outputPanel rendered="{! !isAdmin }">
                <div class="slds" id="page_messages">
                    <div role="alert" class="slds-notify slds-notify_toast slds-notify--toast slds-theme_info slds-theme--info">
                        <div class="notify__content">
                            <div class="slds-media">
                                <div class="slds-media__figure">
                                    <apex:outputText>
                                        <svg class="slds-icon" aria-hidden="true" viewBox="0 0 24 24">
                                            <path  d="M12 .9C5.9.9.9 5.9.9 12s5 11.1 11.1 11.1 11.1-5 11.1-11.1S18.1.9 12 .9zm0 5.6c.8 0 1.4.6 1.4 1.4s-.6 1.4-1.4 1.4-1.4-.6-1.4-1.4.6-1.4 1.4-1.4zm2.3 9.7c0 .2-.2.4-.5.4h-3.6c-.3 0-.5-.1-.5-.4v-.9c0-.3.2-.5.5-.5.2 0 .4-.2.4-.4v-1.9c0-.2-.2-.5-.4-.5-.3 0-.5-.1-.5-.4v-.9c0-.3.2-.5.5-.5h2.7c.3 0 .5.2.5.5v3.7c0 .2.2.4.4.4.3 0 .5.2.5.5v.9z"/>
                                        </svg>
                                    </apex:outputText>
                                </div>
                                <div class="slds-media__body">
                                    <h2 class="slds-text-heading_small slds-text-heading--small">
                                        <apex:outputText value="{!$Label.PageMessagesInfo}: " />
                                        <apex:outputText value="{!$Label.stgCRLPNonAdminError}"/>
                                    </h2>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </apex:outputPanel>

            <div class="slds-card {!IF(isPolling,'','slds-hide')}">
                <div class="slds-col slds-size--1-of-1 slds-m-around--medium">
                    <p class="slds-text-body--small slds-m-top--x-small">
                        <apex:outputText rendered="{!isPolling}" value="{!$Label.stgDeploymentInProgress}" />
                    </p>
                </div>
            </div>

            <apex:actionPoller action="{!checkDeploymentStatus}"
                               enabled="{!isPolling}"
                               reRender="form"
                               interval="5"
                               status="deploymentStatus"
                               />

            <div class="slds-grid {!IF(isHHAccount, '', 'slds-hide')}">
                <div class="slds-col slds-size--1-of-1 slds-m-around--medium">

                    <div>

                        <!-- DISABLED MODE -->
                        <apex:outputPanel rendered="{! !stgService.stgCRLP.Customizable_Rollups_Enabled__c && !isPolling}">
                            <apex:commandButton id="enableCRLPs" value="Enable Customizable Rollups" styleClass="slds-m-vertical_small slds-button slds-button_neutral" action="{!enableCRLPs}" status="statusLoad" immediate="false" rerender="form, status, idPanelSchedule, idPanelConRole, idPanelMembership, idPanelAllocations, UDRsTreeItem, donorStatsTreeItem" /><br/>
                            <apex:outputText escape="false" styleClass="slds-form-element__help" value="{!$Label.stgHelpCustomizableRollupsEnable3}" rendered="{! !isPolling }" />
                        </apex:outputPanel>

                        <!-- ENABLED MODE -->
                        <apex:outputPanel rendered="{! stgService.stgCRLP.Customizable_Rollups_Enabled__c && !isPolling}">

                            <apex:commandButton id="navigateCRLPs" value="{!$Label.stgCRLPGoToSetup}" styleClass="slds-m-bottom_large slds-button slds-button_neutral" action="{!navigate}" /><br/>

                            <div class="slds-section-title--divider" >Advanced Options</div>

                            <apex:outputText escape="false" styleClass="slds-m-vertical_small slds-form-element__help" value="Disabling this feature will not remove any changes you've made unless you reset to the NPSP defaults." />
                            <apex:commandButton styleClass="slds-m-vertical_small slds-button slds-button_neutral" id="disableCRLPs" value="Disable Customizable Rollups" action="{!disableCRLPs}" status="statusLoad" immediate="false" rerender="form, status, idPanelSchedule, idPanelConRole, idPanelMembership, idPanelAllocations, UDRsTreeItem, donorStatsTreeItem"/><br/>
                            <button type="button" class="slds-m-vertical_small slds-button slds-button_destructive" data-toggle="modal" data-target="warning_modal" id="resetBTN">
                                {!$Label.stgCRLPReset}
                            </button>

                        </apex:outputPanel>

                    </div>
                </div>

<!--
                <div class="slds-grid slds-grid_align-center slds-grid_vertical-align-center slds-p-around_large">
                    <apex:commandButton id="saveCRLPs" value="{!$Label.stgBtnSave}" status="statusLoad" action="{!saveSettings}" immediate="false" rendered="{!isEditMode}" rerender="form, status, idPanelSchedule, idPanelConRole, idPanelMembership, idPanelAllocations, UDRsTreeItem, donorStatsTreeItem" styleClass="slds-button slds-button_small slds-button_brand" />
                    <apex:commandButton id="cancelCRLPs" value="{!$Label.stgBtnCancel}" status="statusLoad" action="{!cancelEdit}" immediate="true" rendered="{!isEditMode}" rerender="form" styleClass="slds-button slds-button_small slds-button_neutral" />
                </div>
-->

            </div>
            <apex:actionFunction name="reset" action="{!resetRollupsToDefaultConfig}" reRender="form" status="statusLoad" />

        </apex:form>

        <!-- RESET WARNING MODAL -->
        <div class="slds-scope">
            <div id="warning_modal" tabindex="-1" aria-hidden="true" aria-labelledby="warning_modal_heading" role="dialog" class="slds-modal">
                <div class="slds-modal__container">
                    <div class="slds-modal__header">
                        <h2 id="warning_modal_heading" class="slds-text-heading_medium">{!$Label.CONV_Warning}</h2>
                        <button class="slds-button slds-button_icon-inverse slds-modal__close" data-dismiss="modal" data-target="warning_modal">
                            <svg aria-hidden="true" class="slds-button__icon slds-button__icon_large" data-dismiss="modal" data-target="warning_modal" viewBox="0 0 24 24">
                                <path  data-dismiss="modal" data-target="warning_modal" d="M14.6 11.9l6-6c.3-.3.3-.7 0-1l-.9-1c-.3-.3-.7-.3-1 0L12.6 10c-.1.2-.4.2-.6 0L6 3.9c-.3-.3-.7-.3-1 0l-1 .9c-.3.3-.3.7 0 1l6.1 6.1c.1.1.1.4 0 .6L4 18.6c-.3.3-.3.7 0 1l.9.9c.3.3.7.3 1 0l6.1-6c.2-.2.5-.2.6 0l6.1 6c.3.3.7.3 1 0l.9-.9c.3-.3.3-.7 0-1l-6-6c-.2-.2-.2-.5 0-.7z"/>
                            </svg>
                            <span class="slds-assistive-text">Close</span>
                        </button>
                    </div>
                    <div class="slds-modal__content slds-p-around_medium">
                        <p>
                            {!$Label.CRLP_ResetRollupsWarning}
                        </p>
                    </div>
                    <div class="slds-modal__footer">
                        <div class="slds-x-small-buttons_horizontal">
                            <button class="slds-button slds-button_neutral" data-dismiss="modal" data-target="warning_modal">{!$Label.CONV_Cancel}</button>
                            <button id="warning_modal_reset_button" class="slds-button slds-button_destructive" data-dismiss="modal" data-target="warning_modal">{!$Label.stgReset}</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="slds-backdrop" tabindex="-1"></div>
        </div>

        <script type="text/javascript">
            document.getElementById('warning_modal_reset_button').addEventListener('click', reset);
        </script>

    </div>

</apex:page>